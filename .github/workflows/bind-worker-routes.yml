name: Bind Worker Routes

on:
  workflow_dispatch:

jobs:
  bind:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bind Worker routes via Cloudflare API
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          WORKER_NAME: hgnc-team-portals-worker
          VIEWER_DOMAIN: hgnc-gameday.pages.dev
        run: |
          set -euo pipefail
          if [ -z "${CF_API_TOKEN:-}" ]; then
            echo "CF_API_TOKEN not set; aborting"
            exit 1
          fi

          echo "Checking for zone for $VIEWER_DOMAIN..."
          ZONE_JSON=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=${VIEWER_DOMAIN}" -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json")

          ZONE_COUNT=$(echo "$ZONE_JSON" | jq -r '.result | length')
          if [ "$ZONE_COUNT" -eq 0 ]; then
            echo "::error::Zone for $VIEWER_DOMAIN not found in your account. Pages domains are often managed by Cloudflare and cannot be bound via the Zones API."
            echo "Manual step required: Go to Cloudflare Dashboard → Workers → select '$WORKER_NAME' → Add route:"
            echo "  - $VIEWER_DOMAIN/teams/*"
            echo "  - $VIEWER_DOMAIN/p/*"
            echo "Once added, re-run this workflow to verify the binding."
            exit 1
          fi

          ZONE_ID=$(echo "$ZONE_JSON" | jq -r '.result[0].id')
          echo "Found zone id: $ZONE_ID"

          for SUFFIX in "/teams/*" "/p/*"; do
            PATTERN="$VIEWER_DOMAIN$SUFFIX"
            echo "Creating route $PATTERN → $WORKER_NAME"
            RESP=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/workers/routes" -H "Authorization: Bearer $CF_API_TOKEN" -H "Content-Type: application/json" -d "{\"pattern\":\"$PATTERN\",\"script\":\"$WORKER_NAME\"}")
            if echo "$RESP" | jq -e '.success' >/dev/null 2>&1; then
              echo "Route created: $PATTERN"
            else
              echo "Failed to create route. API response:"
              echo "$RESP"
              exit 1
            fi
          done

          echo "All routes created successfully."
