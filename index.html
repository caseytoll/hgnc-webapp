<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="generator" content=
  "HTML Tidy for HTML5 for Apple macOS version 5.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Team Manager">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6a0dad">
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRlYW0gTWFuYWdlciAtIE5ldGJhbGwgU3RhdHMgJiBTY2hlZHVsZXMiLAogICJzaG9ydF9uYW1lIjogIlRlYW0gTWFuYWdlciIsCiAgImRlc2NyaXB0aW9uIjogIk1hbmFnZSB5b3VyIG5ldGJhbGwgdGVhbSdzIHBsYXllcnMsIGdhbWVzLCBzdGF0cywgYW5kIHNjaGVkdWxlcyIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzFhMWEyZSIsCiAgInRoZW1lX2NvbG9yIjogIiM2YTBkYWQiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdC1wcmltYXJ5IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA1MTIgNTEyJyUzRSUzQ3JlY3QgZmlsbD0nJTIzNmEwZGFkJyB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgcng9JzEyOCcvJTNFJTNDdGV4dCB4PSc1MCUyNScgeT0nNTAlMjUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZvbnQtZmFtaWx5PSdzeXN0ZW0tdWknIGZvbnQtc2l6ZT0nMjgwJyBmb250LXdlaWdodD0nYm9sZCcgZmlsbD0nd2hpdGUnJTNFVE0lM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiYW55IiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect fill='%236a0dad' width='180' height='180' rx='40'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='system-ui' font-size='100' font-weight='bold' fill='white'%3ETM%3C/text%3E%3C/svg%3E">
  <base target="_top">
  <title>Team Manager v619</title>
  <!-- App version: <?= appVersion ?> -->
  <?!= include('styles'); ?>

  <style>
    /* Fixed modal overlay */
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 500;
    }
    .custom-modal-overlay.hidden {
        display: none;
    }
    .custom-modal-content {
        background: var(--content-bg);
        padding: 24px;
        border-radius: 12px;
        width: 90%;
        max-width: 350px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .custom-modal-content h3 {
        margin-top: 0;
        font-size: 1.2em;
        color: var(--primary-color);
    }
    .custom-modal-content p {
        margin-bottom: 20px;
        color: #333;
    }
    .custom-modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .custom-modal-actions button {
        padding: 10px 16px;
        font-weight: 600;
    }
    .custom-modal-actions .confirm-ok {
        background-color: var(--primary-color);
    }
    .custom-modal-actions .confirm-cancel {
        background-color: var(--border-color);
        color: #333;
    }
    .custom-modal-actions .alert-close {
        width: 100%;
    }
    .error-modal-title {
        color: var(--danger-color) !important;
    }
    
    /* Test insights & tab button styles (moved here to satisfy HTML5 tooling)
       Originally placed after body scripts; kept in head for best practice */
    .test-insights-btn {
        position: absolute;
        top: 18px;
        right: 24px;
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border: none;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(60, 60, 120, 0.10);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.35em;
        cursor: pointer;
        transition: box-shadow 0.18s, background 0.18s, opacity 0.18s;
        opacity: 0.92;
        color: #3a3a5a;
    }
    .test-insights-btn:hover, .test-insights-btn:focus {
        background: linear-gradient(135deg, #e0e7ff 0%, #b6c6e6 100%);
        box-shadow: 0 4px 16px rgba(60, 60, 120, 0.18);
        opacity: 1;
        outline: none;
    }
    .test-insights-btn span[role="img"] {
        filter: drop-shadow(0 1px 0 #fff) drop-shadow(0 2px 2px #b6c6e6);
        font-size: 1.2em;
        line-height: 1;
    }

    /* Refresh button styling */
    #refresh-insights-btn:hover {
        background: linear-gradient(135deg, #e0e7ff 0%, #b6c6e6 100%);
        box-shadow: 0 4px 16px rgba(60, 60, 120, 0.18);
        opacity: 1;
        transform: scale(1.05);
    }
    #refresh-insights-btn:active {
        transform: scale(0.95);
    }

    /* Insights Tab Button Styling */
    .insights-tab-btn {
        position: relative;
        background: none;
        border: none;
        outline: none;
        z-index: 2;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
    }
    .insights-tab-btn .icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #3a3a5a;
        font-size: 1.35em;
        box-shadow: 0 1px 4px rgba(60, 60, 120, 0.08);
        margin: 0 auto 2px auto;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
    }
    .insights-tab-btn.active .icon,
    .insights-tab-btn:active .icon,
    .insights-tab-btn:focus .icon {
        background: linear-gradient(135deg, #e0e7ff 0%, #b6c6e6 100%);
        color: #5a3aff;
        box-shadow: 0 2px 8px rgba(60, 60, 120, 0.16);
    }
    .insights-tab-btn:hover .icon {
        background: linear-gradient(135deg, #e0e7ff 0%, #b6c6e6 100%);
        color: #5a3aff;
        box-shadow: 0 2px 8px rgba(60, 60, 120, 0.16);
    }
    .insights-tab-btn .icon:before {
        content: '';
        display: block;
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        border-radius: 50%;
        pointer-events: none;
    }
    /* Reserve space for optional subtitle notes to avoid layout shift
       When a subtitle is hidden we keep the vertical space using visibility:hidden */
    .card-subtitle { min-height: 1.25em; }
    .card-subtitle.hidden { visibility: hidden; }
    .insights-tab-btn span {
        display: block;
        font-size: 0.92em;
        color: #3a3a5a;
        font-weight: 500;
        letter-spacing: 0.01em;
    }
    .insights-tab-btn.active span,
    .insights-tab-btn:active span,
    .insights-tab-btn:focus span {
        color: #5a3aff;
    }
    .insights-tab-btn:hover span {
        color: #5a3aff;
    }
    /* Experimental badge for test insights */
    .experimental-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(90,58,255,0.12);
        color: #5a3aff;
        border: 1px solid rgba(90,58,255,0.14);
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
        z-index: 20;
    }
    /* Visual cue for low-sample statistics (de-emphasize small samples) */
    .low-sample {
      opacity: 0.64;
      filter: grayscale(20%);
      transition: opacity 180ms ease, filter 180ms ease;
    }
    /* Hub tab styling */
    .hub-tab {
      background: transparent;
      border: 1px solid transparent;
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      color: var(--secondary-text);
      transition: background 160ms ease, color 160ms ease, box-shadow 160ms ease;
    }
    .hub-tab:hover {
      background: rgba(90,58,255,0.06);
      color: #5a3aff;
    }
    .hub-tab.active, .hub-tab[aria-selected="true"] {
      background: linear-gradient(135deg,#e9e6ff,#efe8ff);
      color: #5a3aff;
      box-shadow: 0 4px 12px rgba(90,58,255,0.06);
      border-color: rgba(90,58,255,0.08);
    }
    /* Accessibility helper: visually-hidden (keeps content available to screen readers) */
    .sr-only {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
    /* Small debug status badge shown to the owner when debug is enabled */
    .test-debug-badge {
      position: fixed;
      left: 12px;
      bottom: 56px;
      z-index: 100000;
      background: rgba(90,58,255,0.95);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 8px 24px rgba(15,12,40,0.28);
      letter-spacing: 0.06em;
      pointer-events: none;
      opacity: 0.98;
      display: none; /* shown when debug enabled */
    }
    /* Leaderboard headers and column layout ‚Äî use grid for exact column alignment */
    .leaderboard-headers {
      display: grid;
      grid-template-columns: 54px 1fr 140px;
      align-items: center;
      gap: 12px;
      padding: 6px 12px;
    }
    /* .leaderboard-item grid layout commented out - now using flex from styles.html */
    /* .leaderboard-item {
      display: grid;
      grid-template-columns: 54px 1fr 140px;
      align-items: center;
      gap: 12px;
      padding: 6px 12px;
    } */
    .leaderboard-headers {
      font-weight: 700;
      color: var(--secondary-text);
      font-size: 0.92em;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 8px;
      background: transparent;
    }
    .leaderboard-headers .col-rank { justify-self: start; }
    .leaderboard-headers .col-player { justify-self: start; padding-left: 0; }
    .leaderboard-headers .col-score { justify-self: end; }

    .leaderboard-item { padding: 12px; border-radius:6px; background: transparent; }
    .leaderboard-item .leaderboard-name { justify-self: start; margin: 0; padding: 0; }
    .leaderboard-goals { justify-self: end; text-align: right; display:flex; flex-direction:column; align-items:flex-end; }
    .leaderboard-goals .score { font-size: 1.2em; font-weight: 700; }
    .leaderboard-subtext { display:block; font-size: 0.92em; color: var(--secondary-text); }
    .leaderboard-subbracket { display:block; font-size: 0.78em; color: var(--secondary-text); margin-top: 4px; }
    .leaderboard-rank { justify-self: start; font-weight: 700; color: var(--secondary-text); }
  </style>
  
  <!-- Service Worker Registration for Offline Support -->
  <script>
    // Register service worker for offline support and caching
    // Note: Service workers in Google Apps Script require a workaround due to sandbox restrictions
    if ('serviceWorker' in navigator && 'caches' in window) {
      window.addEventListener('load', function() {
        // Fallback: Service worker not available in Google Apps Script Apps domain
        // Using cache API directly for offline support
        console.log('[PWA] Running in Google Apps Script environment - using cache fallback');
        
        // Ensure basic caching is available
        if ('caches' in window) {
          caches.open('hgnc-webapp-runtime').then(function(cache) {
            console.log('[PWA] Cache storage initialized for offline support');
          });
        }
      });
    }
  </script>
</head>
<body class="preload">
  <!-- Skip to main content link for keyboard navigation -->
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <!-- Network status indicator -->
  <div id="network-status-indicator" class="network-status" style="display: none;"></div>
  
  <!-- Install PWA banner -->
  <div id="install-pwa-banner" class="install-banner hidden">
    <div class="install-banner-content">
      <span class="install-banner-icon">üì±</span>
      <div class="install-banner-text">
        <strong>Install Team Manager</strong>
        <span>Add to home screen for quick access</span>
      </div>
      <button onclick="dismissInstallBanner()" class="install-banner-dismiss">‚úï</button>
      <button onclick="showInstallPrompt()" class="install-banner-btn">Install</button>
    </div>
  </div>
  
  <div id="fixed-header-container" class="fixed-header-wrapper">
    <header class="app-header">
      <h1 class="page-title">Team Manager</h1>
      <img src="#" alt="HGNC Logo" class="header-logo" id="main-logo">
    </header>
  </div>
  <div id="loading-overlay" style="display: flex !important; visibility: visible !important; position: fixed !important; z-index: 200 !important;">
    <div class="spinner"></div><span>Loading...</span>
  </div>
  <!-- Server data injected as JSON to avoid editor JS diagnostics -->
  <script id="server-data" type="application/json">
    { "userEmail": <?!= JSON.stringify(userEmail || '') ?>,
      "ownerEmail": <?!= JSON.stringify(ownerEmail || '') ?>,
      "showTestInsights": <?!= JSON.stringify(!!showTestInsights) ?>,
  "logoDataUrl": <?!= JSON.stringify(logoDataUrl || '#') ?>,
  "teamPerformanceIconDataUrl": <?!= JSON.stringify(teamPerformanceIconDataUrl || '#') ?>,
  "offensiveLeadersIconDataUrl": <?!= JSON.stringify(offensiveLeadersIconDataUrl || '#') ?>,
  "defensiveWallIconDataUrl": <?!= JSON.stringify(defensiveWallIconDataUrl || '#') ?>,
  "playerAnalysisIconDataUrl": <?!= JSON.stringify(playerAnalysisIconDataUrl || '#') ?> }
  </script>
  <script>
    // Keep debug off by default; set window.DEBUG = true in the console to enable.
    window.DEBUG = window.DEBUG || false;
    // Parse server-injected JSON and expose as JS globals (defensive)
    (function(){
      try {
        var el = document.getElementById('server-data');
        var data = el ? JSON.parse(el.textContent || el.innerText || '{}') : {};
        window._USER_EMAIL = data.userEmail || '';
        window._OWNER_EMAIL = data.ownerEmail || '';
        window.TEST_INSIGHTS_ENABLED = !!data.showTestInsights;
  window.LOGO_DATA_URL = data.logoDataUrl || '#';
  window.TEAM_PERFORMANCE_ICON_DATA_URL = data.teamPerformanceIconDataUrl || '#';
  window.OFFENSIVE_LEADERS_ICON_DATA_URL = data.offensiveLeadersIconDataUrl || '#';
  window.DEFENSIVE_WALL_ICON_DATA_URL = data.defensiveWallIconDataUrl || '#';
  window.PLAYER_ANALYSIS_ICON_DATA_URL = data.playerAnalysisIconDataUrl || '#';
      } catch (e) {
        window._USER_EMAIL = window._USER_EMAIL || '';
        window._OWNER_EMAIL = window._OWNER_EMAIL || '';
        window.TEST_INSIGHTS_ENABLED = typeof window.TEST_INSIGHTS_ENABLED !== 'undefined' ? window.TEST_INSIGHTS_ENABLED : false;
        window.LOGO_DATA_URL = '#';
      }
    })();
  </script>
  <!-- Legacy dev smoke logger removed. The runtime fallback is executed in js-startup.js -->

  <script>

  // Admin controls wiring: calls server helpers via google.script.run
  document.addEventListener('DOMContentLoaded', function() {
    try {
        if (!window.google || !google.script || !google.script.run) return;
        var adminToggle = document.getElementById('admin-toggle-test-insights');
        var adminOwnerInput = document.getElementById('admin-owner-email');
        var adminSetOwnerBtn = document.getElementById('admin-set-owner-btn');
        var adminFeatureStatus = document.getElementById('admin-feature-status');

        // Initialize from server
        google.script.run.withSuccessHandler(function(settings){
            try {
                if (adminToggle) adminToggle.checked = !!settings.testInsightsEnabled;
                if (adminOwnerInput) adminOwnerInput.value = settings.ownerEmail || '';
                if (adminFeatureStatus) adminFeatureStatus.textContent = settings.testInsightsEnabled ? 'Enabled' : 'Disabled';
            } catch (e) { console.warn('admin init populate error', e); }
        }).getAdminSettings();

        if (adminToggle) {
            adminToggle.addEventListener('change', function() {
                var enabled = !!adminToggle.checked;
                google.script.run.withSuccessHandler(function(){
                    if (adminFeatureStatus) adminFeatureStatus.textContent = enabled ? 'Enabled' : 'Disabled';
                    if (typeof showToast === 'function') showToast('Test Insights ' + (enabled ? 'enabled' : 'disabled'));
                }).setTestInsightsEnabled(enabled);
            });
        }

        if (adminSetOwnerBtn) {
            adminSetOwnerBtn.addEventListener('click', function() {
                var newEmail = adminOwnerInput ? adminOwnerInput.value : '';
                google.script.run.withSuccessHandler(function(){
                    if (typeof showToast === 'function') showToast('Owner email updated');
                }).setOwnerEmail(String(newEmail || ''));
            });
        }

    } catch (e) { console.warn('Admin UI wiring failed', e); }
  });
  </script>
  <nav class="bottom-nav hidden" id="app-tab-nav">
    <button id="show-home-tab" class="bottom-nav-button app-nav"
    onclick="showTeamSelector()">
    <span class="nav-label">Teams</span></button>
    <button id="show-fixture-tab"
    class="bottom-nav-button app-nav active" onclick=
    "showView('fixture-view')">
    <span class="nav-label">Schedule</span></button>
    <button id="show-players-tab" class="bottom-nav-button app-nav"
    onclick="showView('players-view')">
    <span class="nav-label">Players</span></button>
    <button id="show-netball-ladder-tab" class="bottom-nav-button app-nav"
    onclick="showView('netball-ladder-view')">
    <span class="nav-label">Ladder</span></button>
    <button id="show-insights-tab"
    class="bottom-nav-button app-nav insights-tab-btn" onclick=
    "showView('insights-view')">
    <span class="nav-label">Stats</span></button>
  </nav>
  <nav class="bottom-nav hidden" id="game-detail-tab-nav">
    <button id="show-home-tab-game" class=
    "bottom-nav-button game-nav" onclick=
    "showTeamSelector()">
    <span class="nav-label">Back</span></button>
    <button id="show-availability-tab"
    class="bottom-nav-button game-nav active" onclick=
    "showGameDetailTab('availability')">
    <span class="nav-label">Availability</span></button>
    <button id="show-lineup-tab"
    class="bottom-nav-button game-nav" onclick=
    "showGameDetailTab('lineup')">
    <span class="nav-label">Lineup</span></button>
    <button id="show-scoring-tab"
    class="bottom-nav-button game-nav" onclick=
    "showGameDetailTab('scoring')">
    <span class="nav-label">Score</span></button>
  </nav>
  <!-- Read-Only Mode Indicator for Parents/Non-Owners -->
  <div id="read-only-banner" class="read-only-banner hidden">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <span>Read-Only Mode: You can view all stats but cannot make changes</span>
  </div>
  <main id="main-content">
    <div id="team-selector-view" class="view">
      <section class="card team-selector-card">
        <div class="card-header team-selector-header">
          <h2 class="card-title">Select a Team</h2>
          <div class="team-header-actions">
            <button id="toggle-edit-mode" class="btn-edit-teams hidden" onclick="toggleTeamEditMode()" aria-label="Edit Teams">Edit</button>
            <button id="show-add-team-modal" class="btn-create-team hidden" aria-label="Create New Team">‚ûï</button>
          </div>
        </div>
        <div id="team-list-container" class="team-list-modern"></div>
      </section>
    </div>
    <div id="players-view" class="view hidden">
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Player List</h2><button id=
          "show-add-player-modal" class=
          "icon-btn hidden">‚ûï</button>
        </div>
        <div id="player-list"></div>
      </section>
    </div>
    <div id="fixture-view" class="view hidden">
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Games</h2><button id=
          "show-add-game-modal" class="icon-btn hidden">‚ûï</button>
        </div>
        <div id="game-list"></div>
      </section>
    </div>
    <div id="insights-offense-hub-view" class="view hidden">
      <button class="back-button" onclick=
      "showView('insights-view')">‚Üê Back to Insights
      Dashboard</button> <button class="back-button" onclick=
      "showTeamSelector()" style="margin-left: 10px;">üè†
      Home</button>
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Team Manager</h2>
        </div>
        <div class="hub-tabs" role="tablist" aria-label="Offensive leaderboards" style="display:flex;gap:8px;margin:10px 0;">
          <button id="offense-hub-tab-singles" class="hub-tab" role="tab" tabindex="0" aria-selected="false" onclick="setOffenseHubTab('singles')">Singles</button>
          <button id="offense-hub-tab-pairs" class="hub-tab" role="tab" tabindex="0" aria-selected="false" onclick="setOffenseHubTab('pairs')">Pairs</button>
          <!-- Show Top 3 / Show All toggle (per-tab) -->
          <button id="offense-show-all-toggle" class="hub-tab" aria-pressed="false" title="Toggle show all results" style="margin-left:auto;">Show Top 3</button>
        </div>

        <div id="offense-tab-singles" style="display:block;">
          <div class="card-subsection">
            <h3 class="card-subtitle">Single Player Leaders</h3>
            <div class="sort-tabs">
              <button id="sort-single-impact" class="sort-tab-button active" onclick="setInsightsSort('single', 'impact')">Total Impact</button>
              <button id="sort-single-avg" class="sort-tab-button" onclick="setInsightsSort('single', 'avg')">Efficiency (Avg)</button>
              <button id="sort-single-qtrs" class="sort-tab-button" onclick="setInsightsSort('single', 'quarters')">Qtrs</button>
            </div>
            <div id="leaderboard-list-total"></div>
            <div id="leaderboard-list-per-qtr" style="margin-top:8px;"></div>
          </div>
        </div>

        <div id="offense-tab-pairs" style="display:none;">
          <div class="card-subsection">
            <h3 class="card-subtitle">GS/GA Pairs (Goals Scored)</h3>
            <p class="card-subtitle hidden" id="insights-offense-subtitle">Note: "Efficiency" sort only shows pairs with 3 or more Qtrs played.</p>
            <div class="sort-tabs">
              <button id="sort-offense-impact" class="sort-tab-button active" onclick="setInsightsSort('offense', 'impact')">Total Impact</button>
              <button id="sort-offense-avg" class="sort-tab-button" onclick="setInsightsSort('offense', 'avg')">Efficiency (Avg)</button>
              <button id="sort-offense-qtrs" class="sort-tab-button" onclick="setInsightsSort('offense', 'quarters')">Qtrs</button>
            </div>
            <div id="insights-offense-combos"></div>
          </div>
        </div>
      </section>
    </div>
    <div id="player-goals-detail-view" class="view hidden">
      <button class="back-button" onclick="showView('insights-offense-hub-view')">‚Üê Back to Offensive Hub</button>
      <button class="back-button" onclick="showTeamSelector()" style="margin-left: 10px;">üè† Home</button>
      <section class="card">
        <h2 class="card-title" id="player-goals-detail-title">Player Goal Details</h2>
        <div id="player-goals-detail-content"></div>
      </section>
    </div>
    <div id="pair-goals-detail-view" class="view hidden">
      <button class="back-button" onclick="showView('insights-offense-hub-view')">‚Üê Back to Offensive Hub</button>
      <button class="back-button" onclick="showTeamSelector()" style="margin-left: 10px;">üè† Home</button>
      <section class="card">
        <h2 class="card-title" id="pair-goals-detail-title">Pair Goal Details</h2>
        <div id="pair-goals-detail-content"></div>
      </section>
    </div>
    <!-- NEW INSIGHTS DASHBOARD -->
    <div id="insights-view" class="view hidden">
      <style>
        /* Runtime overrides: prefer server-injected icon URLs, overriding any inlined base64 backgrounds */
        /* Backgrounds are set at runtime by ensureInsightsCardImages() which reads data-* attributes.
           This avoids embedding template tokens in CSS or inline styles which can break linters and parsers. */
      </style>

      <script>
        // Runtime icon injection handled by ensureInsightsCardImages() in js-startup.html
        // This script ensures data-icon attributes are set with server-injected values as fallback
        // The cards already have data-icon attributes from template rendering, but this provides
        // a fallback mechanism in case template variables evaluate to empty or '#'
        (function () {
          // Use globally-exposed icon data URLs (parsed from server-data JSON)
          var iconUrls = {
            'team-performance': window.TEAM_PERFORMANCE_ICON_DATA_URL,
            'offensive-leaders': window.OFFENSIVE_LEADERS_ICON_DATA_URL,
            'defensive-wall': window.DEFENSIVE_WALL_ICON_DATA_URL,
            'player-analysis': window.PLAYER_ANALYSIS_ICON_DATA_URL
          };
          
          var cards = document.querySelectorAll('.insights-menu-card');
          cards.forEach(function(card) {
            var onclick = card.getAttribute('onclick') || '';
            var viewId = '';
            if (onclick.indexOf('team-performance') !== -1) viewId = 'team-performance';
            else if (onclick.indexOf('offensive-leaders') !== -1) viewId = 'offensive-leaders';
            else if (onclick.indexOf('defensive-wall') !== -1) viewId = 'defensive-wall';
            else if (onclick.indexOf('player-analysis') !== -1) viewId = 'player-analysis';
            
            if (viewId && iconUrls[viewId]) {
              var currentIcon = card.getAttribute('data-icon');
              // If attribute is missing, empty, or '#', set it from global URL
              if (!currentIcon || currentIcon === '#' || currentIcon.trim() === '') {
                card.setAttribute('data-icon', iconUrls[viewId]);
              }
            }
          });
        })();
      </script>
      <!-- Refresh Button (outside dashboard container so it's always visible) -->
      <button id="refresh-insights-btn" onclick="refreshInsightsDashboard()" aria-label="Refresh Stats"
        style="position: absolute; top: 18px; right: 24px; width: 40px; height: 40px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border: none; border-radius: 50%; box-shadow: 0 2px 8px rgba(60, 60, 120, 0.10); display: flex; align-items: center; justify-content: center; font-size: 1.35em; cursor: pointer; transition: all 0.2s; opacity: 0.92; color: #3a3a5a; z-index: 10;">
        <span role="img" aria-label="Refresh">üîÑ</span>
      </button>

      <!-- INSIGHTS MENU -->
      <div class="insights-menu">
        <div class="insights-menu-header">
          <h1 class="insights-menu-title">Team Insights</h1>
          <p class="insights-menu-subtitle">Choose an analysis view</p>
        </div>

        <div class="insights-menu-grid">
          <!-- Team Performance Button (clean) -->
          <div class="insights-menu-card" onclick="showView('insights-team-performance-view')" tabindex="0" role="button" aria-label="View team performance dashboard" data-icon="<?!= teamPerformanceIconDataUrl || '/assets/team-performance-icon.png' ?>">
            <div class="insights-menu-card-content">
              <h3 class="insights-menu-card-title">Team Performance</h3>
            </div>
          </div>

          <!-- Offensive Leaders Button (clean) -->
          <div class="insights-menu-card" onclick="showView('insights-offensive-leaders-view')" tabindex="0" role="button" aria-label="View offensive leaders" data-icon="<?!= offensiveLeadersIconDataUrl || '/assets/Offensive-Leaders-Icon.jpeg' ?>">
            <div class="insights-menu-card-content">
              <h3 class="insights-menu-card-title">Offensive Leaders</h3>
            </div>
          </div>

          <!-- Defensive Wall Button (clean) -->
          <div class="insights-menu-card" onclick="showView('insights-defensive-wall-view')" tabindex="0" role="button" aria-label="View defensive wall" data-icon="<?!= defensiveWallIconDataUrl || '/assets/Defensive-Wall-Icon.jpeg' ?>">
            <div class="insights-menu-card-content">
              <h3 class="insights-menu-card-title">Defensive Wall</h3>
            </div>
          </div>

          <!-- Player Analysis Button (clean) -->
          <div class="insights-menu-card" onclick="showView('insights-player-analysis-view')" tabindex="0" role="button" aria-label="View player analysis" data-icon="<?!= playerAnalysisIconDataUrl || '/assets/player-analysis-icon.webp' ?>">
            <div class="insights-menu-card-content">
              <h3 class="insights-menu-card-title">Player Analysis</h3>
            </div>
          </div>
        </div><!-- End insights-menu-grid -->
      </div><!-- End insights-menu -->
    </div><!-- End insights-view -->

    <!-- TEAM PERFORMANCE DASHBOARD SUB-VIEW -->
    <div id="insights-team-performance-view" class="view hidden">
      <div class="insights-dashboard">
        <!-- TEAM PERFORMANCE OVERVIEW -->
        <div class="dashboard-section dashboard-section-full">
          <div class="dashboard-header">
            <div>
              <h2 class="dashboard-title">Team Performance Dashboard</h2>
              <div class="dashboard-subtitle" id="insights-season-stats">
                <!-- Populated by JS -->
              </div>
            </div>
            <button class="back-btn" onclick="showView('insights-view')" aria-label="Back to Insights">‚Üê Back</button>
          </div>

          <!-- Core Performance Metrics Grid -->
          <div class="perf-metrics-grid">
            <!-- Record Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View record details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Record <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-record">0-0-0</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Record Breakdown</div>
                  <div class="perf-detail-content" id="perf-record-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Win Rate Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View win rate details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Win Rate <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-win-rate">0%</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Win Rate Trend</div>
                  <div class="perf-detail-content" id="perf-winrate-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Goal Diff Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View goal difference details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Goal Diff <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-goal-diff">+0</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Goal Differential</div>
                  <div class="perf-detail-content" id="perf-goaldiff-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Form Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View recent form details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Form (L5) <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value perf-form" id="perf-form">‚Äî</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Recent Games</div>
                  <div class="perf-detail-content" id="perf-form-detail">Loading...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Scoring Efficiency Grid -->
          <div class="perf-metrics-grid" style="margin-top: 12px;">
            <!-- Avg For Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View scoring statistics">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Avg For <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-avg-for">0.0</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Scoring Range</div>
                  <div class="perf-detail-content" id="perf-avgfor-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Avg Against Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View defensive statistics">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Avg Against <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-avg-against">0.0</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Defensive Range</div>
                  <div class="perf-detail-content" id="perf-avgagainst-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Best Quarter Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View best quarter details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Best Quarter <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-best-qtr">Q1</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Best Quarter Stats</div>
                  <div class="perf-detail-content" id="perf-bestqtr-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Top Defender Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View top defender details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Top Defender <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-clean-sheets">‚Äî</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Best Defender by Avg GA/Q</div>
                  <div class="perf-detail-content" id="perf-cleansheets-detail">Loading...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Average Goals Cards -->
          <div class="perf-metrics-grid" style="margin-top: 12px;">
            <!-- Ave Goals For Singles Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View singles scoring average details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Ave Goals For Singles <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-ave-goals-for-singles">‚Äî</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Singles Scoring Average</div>
                  <div class="perf-detail-content" id="perf-ave-goals-for-singles-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Ave Goals Against Singles Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View singles defensive average details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Ave Goals Against Singles <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-ave-goals-against-singles">‚Äî</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Singles Defensive Average</div>
                  <div class="perf-detail-content" id="perf-ave-goals-against-singles-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Ave Goals For Pairs Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View pairs scoring average details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Ave Goals For Pairs <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-ave-goals-for-pairs">‚Äî</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Pairs Scoring Average</div>
                  <div class="perf-detail-content" id="perf-ave-goals-for-pairs-detail">Loading...</div>
                </div>
              </div>
            </div>

            <!-- Ave Goals Against Pairs Card -->
            <div class="perf-flip-container" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View pairs defensive average details">
              <div class="perf-flip-card">
                <div class="perf-card-front">
                  <div class="perf-label">Ave Goals Against Pairs <span class="flip-hint">‚ìò</span></div>
                  <div class="perf-value" id="perf-ave-goals-against-pairs">‚Äî</div>
                </div>
                <div class="perf-card-back">
                  <div class="perf-detail-title">Pairs Defensive Average</div>
                  <div class="perf-detail-content" id="perf-ave-goals-against-pairs-detail">Loading...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- COLLAPSIBLE SECTION: Quarter Performance -->
        <div class="insights-accordion-section">
          <div class="insights-accordion-header" onclick="toggleInsightsSection('quarter-perf')">
            <div class="insights-accordion-title">
              <span class="insights-accordion-icon" id="quarter-perf-icon">‚ñ∂</span>
              <h3>Quarter Performance</h3>
            </div>
            <div class="insights-accordion-summary" id="quarter-perf-summary">
              <span class="summary-badge">Best: <strong id="summary-best-qtr">‚Äî</strong></span>
              <span class="summary-badge">Worst: <strong id="summary-worst-qtr">‚Äî</strong></span>
            </div>
          </div>
          <div class="insights-accordion-content" id="quarter-perf-content" style="display: none;">

        <!-- QUARTER PERFORMANCE SUMMARY -->
        <div class="dashboard-section quarter-summary-card" onclick="showInsightsSubView('insights-team-record-view')" style="margin-top: 0;">
          <div class="dashboard-header">
            <h3 class="dashboard-title">Quarter Performance</h3>
            <span class="chevron-right">‚Ä∫</span>
          </div>
          <div class="quarter-summary-stats">
            <div class="quarter-stat-item">
              <div class="quarter-stat-label">Best</div>
              <div class="quarter-stat-value best" id="insights-best-qtr">Q1</div>
            </div>
            <div class="quarter-stat-item">
              <div class="quarter-stat-label">Worst</div>
              <div class="quarter-stat-value worst" id="insights-worst-qtr">Q3</div>
            </div>
            <div class="quarter-stat-item">
              <div class="quarter-stat-label">Avg. Margin</div>
              <div class="quarter-stat-value" id="insights-avg-margin">+7</div>
            </div>
          </div>
        </div>

        </div>
        </div>

        <!-- COLLAPSIBLE SECTION: Suggested Lineup -->
        <div class="insights-accordion-section">
          <div class="insights-accordion-header" onclick="toggleInsightsSection('lineup')">
            <div class="insights-accordion-title">
              <span class="insights-accordion-icon" id="lineup-icon">‚ñ∂</span>
              <h3>üéØ Suggested Lineup</h3>
            </div>
            <div class="insights-accordion-summary" id="lineup-summary">
              <span class="summary-badge">AI-powered recommendations</span>
            </div>
          </div>
          <div class="insights-accordion-content" id="lineup-content" style="display: none;">
            <!-- Suggested Lineup content goes here -->
          </div>
        </div>
      </div>
    </div>

    <!-- OFFENSIVE LEADERS SUB-VIEW -->
    <div id="insights-offensive-leaders-view" class="view hidden">
      <div class="insights-dashboard">
        <div class="dashboard-section dashboard-section-full">
          <div class="dashboard-header">
            <div>
              <h2 class="dashboard-title">Offensive Leaders</h2>
              <div class="dashboard-subtitle">Top scorers and goal-scoring combinations</div>
            </div>
            <button class="back-btn" onclick="showView('insights-view')" aria-label="Back to Insights">‚Üê Back</button>
          </div>

          <!-- Top Scorer Card -->
          <div class="perf-flip-container perf-large-card" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View top scorer details">
            <div class="perf-flip-card">
              <div class="perf-card-front">
                <div class="perf-label-large">Top Scorer <span class="flip-hint">‚ìò</span></div>
                <div class="perf-value-large" id="offense-top-scorer">‚Äî</div>
                <div class="perf-subtext">Most goals scored</div>
              </div>
              <div class="perf-card-back">
                <div class="perf-detail-title">Leading Goal Scorer</div>
                <div class="perf-detail-content" id="offense-topscorer-detail">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Top Scoring Pair Card -->
          <div class="perf-flip-container perf-large-card" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View top scoring pair details">
            <div class="perf-flip-card">
              <div class="perf-card-front">
                <div class="perf-label-large">Top Scoring Pair <span class="flip-hint">‚ìò</span></div>
                <div class="perf-value-large" id="offense-top-pair">‚Äî</div>
                <div class="perf-subtext">Most goals by GS&amp;GA combination</div>
              </div>
              <div class="perf-card-back">
                <div class="perf-detail-title">Leading Scoring Combination</div>
                <div class="perf-detail-content" id="offense-toppair-detail">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Most Efficient Scorer Card -->
          <div class="perf-flip-container perf-large-card" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View most efficient scorer details">
            <div class="perf-flip-card">
              <div class="perf-card-front">
                <div class="perf-label-large">Most Efficient Scorer <span class="flip-hint">‚ìò</span></div>
                <div class="perf-value-large" id="offense-efficient-scorer">‚Äî</div>
                <div class="perf-subtext">Highest goals per quarter average</div>
              </div>
              <div class="perf-card-back">
                <div class="perf-detail-title">Most Efficient Goal Scorer</div>
                <div class="perf-detail-content" id="offense-efficient-detail">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Offensive Hub Access -->
          <div class="dashboard-section" style="margin-top: 20px; text-align: center;">
            <button class="action-btn-large" onclick="showInsightsSubView('insights-offense-hub-view')" style="width: 100%; max-width: 300px;">
              üìä View Full Offensive Analysis
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- DEFENSIVE WALL SUB-VIEW -->
    <div id="insights-defensive-wall-view" class="view hidden">
      <div class="insights-dashboard">
        <div class="dashboard-section dashboard-section-full">
          <div class="dashboard-header">
            <div>
              <h2 class="dashboard-title">Defensive Wall</h2>
              <div class="dashboard-subtitle">Defensive performance and goals against analysis</div>
            </div>
            <button class="back-btn" onclick="showView('insights-view')" aria-label="Back to Insights">‚Üê Back</button>
          </div>

          <!-- Top Defender Card -->
          <div class="perf-flip-container perf-large-card" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View top defender details">
            <div class="perf-flip-card">
              <div class="perf-card-front">
                <div class="perf-label-large">Top Defender <span class="flip-hint">‚ìò</span></div>
                <div class="perf-value-large" id="defense-top-defender">‚Äî</div>
                <div class="perf-subtext">Lowest goals against average</div>
              </div>
              <div class="perf-card-back">
                <div class="perf-detail-title">Best Defender by Goals Against</div>
                <div class="perf-detail-content" id="defense-topdefender-detail">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Top Defensive Pair Card -->
          <div class="perf-flip-container perf-large-card" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View top defensive pair details">
            <div class="perf-flip-card">
              <div class="perf-card-front">
                <div class="perf-label-large">Top Defensive Pair <span class="flip-hint">‚ìò</span></div>
                <div class="perf-value-large" id="defense-top-pair">‚Äî</div>
                <div class="perf-subtext">Lowest goals against by GD&amp;GK combination</div>
              </div>
              <div class="perf-card-back">
                <div class="perf-detail-title">Best Defensive Combination</div>
                <div class="perf-detail-content" id="defense-toppair-detail">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Clean Sheet Leader Card -->
          <div class="perf-flip-container perf-large-card" onclick="flipPerfCard(this)" tabindex="0" role="button" aria-label="View clean sheet leader details">
            <div class="perf-flip-card">
              <div class="perf-card-front">
                <div class="perf-label-large">Clean Sheet Leader <span class="flip-hint">‚ìò</span></div>
                <div class="perf-value-large" id="defense-clean-sheets">‚Äî</div>
                <div class="perf-subtext">Most quarters with zero goals conceded</div>
              </div>
              <div class="perf-card-back">
                <div class="perf-detail-title">Clean Sheet Performance</div>
                <div class="perf-detail-content" id="defense-cleansheets-detail">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Defensive Analysis Access -->
          <div class="dashboard-section" style="margin-top: 20px; text-align: center;">
            <button class="action-btn-large" onclick="showInsightsSubView('insights-defenders-view')" style="width: 100%; max-width: 300px;">
              üõ°Ô∏è View Full Defensive Analysis
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="netball-ladder-view" class="view hidden">
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Ladder</h2><button class="icon-btn" onclick=
          "refreshLadderManually()" title=
          "Refresh from API">‚ü≥</button>
        </div>
        <div id="netball-ladder-table">
          <div class="empty-state">
            Loading ladder data...
          </div>
        </div>
      </section>
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Round by Round
          Fixture</h2><button class="icon-btn" onclick=
          "refreshResultsManually()" title=
          "Refresh from API">‚ü≥</button>
        </div>
        <div id="netball-results-container">
          <div class="empty-state">
            Loading match data...
          </div>
        </div>
      </section>
    </div>
    <div id="admin-view" class="view hidden">
      <button class="back-button" onclick="showTeamSelector()">üè†
      Home</button>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">
        NetballConnect Auth Token</h3>
        <p class="card-subtitle">Paste the Authorization token
        copied from the browser's Network tab here when it
        expires.</p>
        <textarea id="admin-auth-token" rows="5" style=
        "width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9em; box-sizing: border-box;">
        </textarea>
        <div style=
        "margin-top: 10px; display: flex; justify-content: flex-end;">
          <button id="admin-save-token-btn" style=
          "padding: 10px 16px;">Save New Token</button>
        </div>
        <p style="margin-top: 20px; font-size: 0.9em;">Current
        Status: <span id="admin-token-status" style=
        "font-weight: bold; color: var(--secondary-text);">Loading...</span></p>
        <hr style=
        "margin: 12px 0; border: none; border-top: 1px solid var(--border-color); opacity: 0.6;">

        <div id="admin-feature-controls" style="margin-top:12px;">
          <h4 style="margin:6px 0 8px 0;">Feature
          Flags</h4><label style=
          "display:flex;align-items:center;gap:8px;"><input type=
          "checkbox" id="admin-toggle-test-insights"> <span>Enable
          Test Insights (server-wide)</span></label>
          <p style=
          "margin:8px 0 0 0;font-size:0.9em;color:var(--secondary-text);">
          Server flag: <strong id=
          "admin-feature-status">Loading...</strong></p>
          <h4 style="margin:12px 0 8px 0;">Owner Account</h4>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="admin-owner-email" type="email" placeholder=
            "owner@example.com" style=
            "flex:1;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
            <button id="admin-set-owner-btn" style=
            "padding:8px 12px;">Set Owner</button>
          </div>
        </div>
      </section>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">
        Opponent Difficulty Ratings (DR)</h3>
        <p class="card-subtitle">Calculated based on external team
        points and goal percentage.</p>
        <div class="position-grid-wrapper">
          <table class="position-grid insights-table" id=
          "admin-dr-table"></table>
        </div>
      </section>
    </div>
    <div id="game-detail-view" class="view hidden">
      <header class="game-detail-header">
        <button class="back-button" onclick=
        "showView('fixture-view')">‚Üê Back to Fixture</button>
        <h1 id="game-detail-title" class="page-title">vs
        Opponent</h1>
        <button id="fullscreen-toggle-btn" class="icon-btn" onclick="toggleFullscreen()" 
        title="Toggle Fullscreen">‚õ∂</button>
        <button id="share-game-btn" class="icon-btn" onclick="shareCurrentGame()" 
        title="Share Game Result">üì§</button>
      </header>
      <div class="sticky-score-wrapper">
        <section class="card total-score-card">
          <div class="score-team">
            <h5>Us</h5>
            <div id="total-score-us" class="score">
              0
            </div>
          </div>
          <div class="score-separator">
            -
          </div>
          <div class="score-team">
            <h5 id="total-score-opponent-name">Opponent</h5>
            <div id="total-score-opponent" class="score">
              0
            </div>
          </div>
        </section>
      </div>
      <section id="availability-content" class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">Player
        Availability</h3>
        <div id="game-availability-list"></div>
      </section>
      <section id="game-lineup-content" class="card hidden">
        <div class="card-header">
          <h3 class="card-title" style=
          "margin: 0; padding: 0; border: none;">
          Lineup</h3><button id="show-share-modal-btn" style=
          "padding: 8px 12px; font-size: 0.9em;">üì• Share
          Lineup</button>
        </div>
        <div id="lineup-status-card" class="card" style=
        "background-color: var(--bg-color);"></div>
        <div class="position-grid-wrapper">
          <table class="position-grid" id="position-grid-table">
          </table>
        </div>
      </section>
      <section id="scoring-content" class="card hidden">
        <div class="goals-grid" id="goals-grid-container"></div>
      </section>
    </div>
    <div id="player-detail-view" class="view hidden">
      <header class="game-detail-header">
        <button class="back-button" onclick=
        "showView('players-view')">‚Üê Back to Players</button>
        <button class="back-button" onclick="showTeamSelector()"
        style="margin-left: 10px;">üè† Home</button>
        <h1 id="player-detail-name" class="page-title">Player
        Name</h1>
      </header>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">Season
        Summary</h3>
        <div class="stat-grid">
          <div class="stat-card">
            <div id="player-detail-games" class="stat-value">
              0
            </div>
            <div class="stat-label">
              Games Played
            </div>
          </div>
          <div class="stat-card">
            <div id="player-detail-goals" class="stat-value">
              0
            </div>
            <div class="stat-label">
              Total Goals
            </div>
          </div>
        </div>
      </section>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">
        Position Summary (Qtrs)</h3>
        <div id="player-detail-positions" class=
        "position-summary-list"></div>
      </section>
    </div>
    <div id="insights-team-record-view" class="view hidden">
      <button class="back-button" onclick=
      "showView('insights-view')">‚Üê Back to Insights
      Dashboard</button> <button class="back-button" onclick=
      "showTeamSelector()" style="margin-left: 10px;">üè†
      Home</button>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">Round
        by Round</h3>
        <div id="insights-team-record-table"></div>
      </section>
    </div>
    <div id="insights-player-stats-view" class="view hidden">
      <button class="back-button" onclick=
      "showView('insights-view')">‚Üê Back to Insights
      Dashboard</button> <button class="back-button" onclick=
      "showTeamSelector()" style="margin-left: 10px;">üè†
      Home</button>
      
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">Player Scoring Stats</h3>
        <p class="card-subtitle">Players and pairs with 3+ quarters played</p>
        
        <div class="stats-section">
          <h4>Single Players - Total Goals & Goal Average</h4>
          <div id="player-scoring-stats"></div>
        </div>
        
        <div class="stats-section">
          <h4>GS&amp;GA Pairs - Total Goals &amp; Goal Average</h4>
          <div id="pairs-scoring-stats"></div>
        </div>
      </section>
      
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">Defensive Stats</h3>
        <p class="card-subtitle">Players and pairs with 3+ quarters played</p>
        
        <div class="stats-section">
          <h4>Single Players - Goals Against Average</h4>
          <div id="player-defensive-stats"></div>
        </div>
        
        <div class="stats-section">
          <h4>GD&amp;GK Pairs - Goals Against Average</h4>
          <div id="pairs-defensive-stats"></div>
        </div>
      </section>
    </div><!-- Removed empty/duplicate insights-offense-view -->
    <div id="insights-defense-view" class="view hidden">
      <button class="back-button" onclick=
      "showView('insights-view')">‚Üê Back to Insights
      Dashboard</button> <button class="back-button" onclick=
      "showTeamSelector()" style="margin-left: 10px;">üè†
      Home</button>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">GD/GK
        Pairs (Goals Conceded)</h3>
        <p class="card-subtitle hidden" id="insights-defense-subtitle">Note: "Efficiency" sort only shows pairs with 3 or more Qtrs played.</p>
        <div class="sort-tabs">
          <button id="sort-defense-impact" class=
          "sort-tab-button active" onclick=
          "setInsightsSort('defense', 'impact')">Total
          Impact</button> <button id="sort-defense-avg" class=
          "sort-tab-button" onclick=
          "setInsightsSort('defense', 'avg')">Efficiency
          (Avg)</button> <button id="sort-defense-qtrs" class=
          "sort-tab-button" onclick=
          "setInsightsSort('defense', 'quarters')">Qtrs</button>
        </div>
        <div id="insights-defense-combos"></div>
      </section>
    </div>
    <div id="insights-defenders-view" class="view hidden">
      <button class="back-button" onclick=
      "showView('insights-view')">‚Üê Back to Insights
      Dashboard</button> <button class="back-button" onclick=
      "showTeamSelector()" style="margin-left: 10px;">üè†
      Home</button>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">Top
        GD/GK Individuals (Goals Conceded)</h3>
        <p class="card-subtitle hidden" id="insights-defenders-subtitle">Note: "Efficiency" sort only shows players with 3 or more Qtrs played.</p>
        <div class="sort-tabs">
          <button id="sort-defenders-impact" class=
          "sort-tab-button active" onclick=
          "setInsightsSort('defenders', 'impact')">Total
          Impact</button> <button id="sort-defenders-avg" class=
          "sort-tab-button" onclick=
          "setInsightsSort('defenders', 'avg')">Efficiency
          (Avg)</button> <button id="sort-defenders-qtrs" class=
          "sort-tab-button" onclick=
          "setInsightsSort('defenders', 'quarters')">Qtrs</button>
        </div>
        <div id="insights-top-defenders"></div>
      </section>
    </div>

    <!-- PLAYER ANALYSIS VIEW -->
    <div id="insights-player-analysis-view" class="view hidden">
      <div id="insights-player-analysis-error-banner" class="error-banner hidden"></div>
      <button class="back-button" onclick="showView('insights-view')">‚Üê Back to Insights Dashboard</button> <button class="back-button" onclick="showTeamSelector()" style="margin-left: 10px;">üè† Home</button>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">Player Analysis</h3>
        <p class="card-subtitle">Individual player performance metrics and versatility analysis</p>

        <!-- Player Superlatives Section -->
        <div class="dashboard-section">
          <h4 class="card-subtitle" style="margin-bottom: 16px;">Player Superlatives</h4>
          <div class="superlatives-grid">
            <div class="superlative-card" id="superlative-top-gun">
              <div class="superlative-icon">üèÜ</div>
              <div class="superlative-content">
                <h5 class="superlative-title">Top Gun</h5>
                <p class="superlative-value" id="top-gun-name">‚Äî</p>
                <p class="superlative-detail" id="top-gun-detail">Most goals scored</p>
              </div>
            </div>
            <div class="superlative-card" id="superlative-iron-woman">
              <div class="superlative-icon">üí™</div>
              <div class="superlative-content">
                <h5 class="superlative-title">Iron Woman</h5>
                <p class="superlative-value" id="iron-woman-name">‚Äî</p>
                <p class="superlative-detail" id="iron-woman-detail">Most quarters played</p>
              </div>
            </div>
            <div class="superlative-card" id="superlative-swiss-army">
              <div class="superlative-icon">üîß</div>
              <div class="superlative-content">
                <h5 class="superlative-title">Swiss Army Knife</h5>
                <p class="superlative-value" id="swiss-army-name">‚Äî</p>
                <p class="superlative-detail" id="swiss-army-detail">Most versatile player</p>
              </div>
            </div>
            <div class="superlative-card" id="superlative-leader">
              <div class="superlative-icon">üëë</div>
              <div class="superlative-content">
                <h5 class="superlative-title">Team Leader</h5>
                <p class="superlative-value" id="leader-name">‚Äî</p>
                <p class="superlative-detail" id="leader-detail">Most captaincies</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Player Performance Table -->
        <div class="dashboard-section">
          <h4 class="card-subtitle" style="margin-bottom: 16px;">Player Performance Overview</h4>
          <div class="sort-tabs">
            <button id="sort-analysis-goals" class="sort-tab-button active" onclick="setPlayerAnalysisSort('goals')">Total Goals</button>
            <button id="sort-analysis-quarters" class="sort-tab-button" onclick="setPlayerAnalysisSort('quarters')">Quarters</button>
            <button id="sort-analysis-versatility" class="sort-tab-button" onclick="setPlayerAnalysisSort('versatility')">Versatility</button>
            <button id="sort-analysis-games" class="sort-tab-button" onclick="setPlayerAnalysisSort('games')">Games</button>
          </div>
          <div class="position-grid-wrapper">
            <table class="position-grid insights-table" id="insights-player-analysis-table"></table>
          </div>
        </div>
      </section>
    </div>

    <div id="insights-player-plusminus-view" class="view hidden">
      <button class="back-button" onclick=
      "showView('insights-view')">‚Üê Back to Insights
      Dashboard</button> <button class="back-button" onclick=
      "showTeamSelector()" style="margin-left: 10px;">üè†
      Home</button>
      <section class="card">
        <h3 class="card-title" style="margin-bottom: 12px;">Player
        +/- by Position</h3>
        <p class="card-subtitle hidden" id="insights-pm-subtitle">Note: "Avg +/-" sort only shows players with 3 or more Qtrs in that position.</p>
        <div class="sort-tabs">
          <button id="sort-pm-total" class="sort-tab-button active"
          onclick="setInsightsPlusMinusSort('total')">Total
          +/-</button> <button id="sort-pm-avg" class=
          "sort-tab-button" onclick=
          "setInsightsPlusMinusSort('avg')">Avg +/-</button>
          <button id="sort-pm-qtrs" class="sort-tab-button"
          onclick="setInsightsPlusMinusSort('quarters')">Qtrs</button>
        </div>
        <div class="position-grid-wrapper">
          <table class="position-grid insights-table" id=
          "insights-player-plusminus-table"></table>
        </div>
      </section>
    </div>
  </main>
  <div id="edit-team-modal" class="modal-overlay hidden" onclick=
  "closeModal(event, 'edit-team-modal')">
    <div class="modal-content">
      <h3 id="edit-team-modal-title">Edit Team</h3><label for=
      "edit-team-year">Year</label> <input type="number" id=
      "edit-team-year" placeholder="e.g., 2026"> <label for=
      "edit-team-season">Season</label> <select id=
      "edit-team-season">
        <option value="Season 1">
          Season 1
        </option>
        <option value="Season 2">
          Season 2
        </option>
        <option value="NFNL">
          NFNL
        </option>
        <option value="Other">
          Other
        </option>
      </select> <label for="edit-team-name">Team Name</label>
      <input type="text" id="edit-team-name" placeholder=
      "e.g., U11"> <label for="edit-team-photo">Team Photo (Optional)</label>
      <input type="file" id="edit-team-photo" accept="image/*" capture="environment" 
      onchange="handleTeamPhotoUpload(this)">
      <div id="team-photo-preview" style="margin-top: 8px; display: none;">
        <!-- img src intentionally omitted - set dynamically via JavaScript when file is selected -->
        <img id="team-photo-preview-img" alt="Team photo preview" style="max-width: 200px; border-radius: 8px; border: 1px solid var(--border-color);">
      </div>
      <label for="edit-team-ladder-name">External
      Ladder Name (Match Exact Text)</label> <input type="text" id=
      "edit-team-ladder-name" placeholder=
      "e.g., U11-A (for NetballConnect)"> <label for=
      "edit-team-ladder-api">Ladder API URL</label> <input type="url"
      id="edit-team-ladder-api" placeholder=
      "https://api.example.com/ladder"> <label for=
      "edit-team-results-api">Results API URL</label> <input type="url"
      id="edit-team-results-api" placeholder=
      "https://api.example.com/results">
      <div class="modal-actions">
        <button class="cancel-btn" onclick=
        "hideModal('edit-team-modal')">Cancel</button> <button id=
        "update-team-button">Update</button>
      </div>
      <div class="modal-delete-zone hidden">
        <button id="delete-team-button" class=
        "delete-button-modal">Delete Team</button>
      </div>
    </div>
  </div>
  <div id="edit-player-modal" class="modal-overlay hidden" onclick=
  "closeModal(event, 'edit-player-modal')">
    <div class="modal-content">
      <h3>Edit Player</h3><label for="edit-player-name">Player
      Name</label> <input type="text" id="edit-player-name"
      placeholder="Player Name">
      
      <label for="edit-player-fav-position">Favorite Position (optional)</label>
      <select id="edit-player-fav-position">
        <option value="">Auto (best avg +/-)</option>
        <option value="GS">GS - Goal Shooter</option>
        <option value="GA">GA - Goal Attack</option>
        <option value="WA">WA - Wing Attack</option>
        <option value="C">C - Centre</option>
        <option value="WD">WD - Wing Defence</option>
        <option value="GD">GD - Goal Defence</option>
        <option value="GK">GK - Goal Keeper</option>
      </select>
      
      <div class="modal-actions">
        <button class="cancel-btn" onclick=
        "hideModal('edit-player-modal')">Cancel</button>
        <button id="update-player-button">Update</button>
      </div>
      <div class="modal-delete-zone hidden">
        <button id="delete-player-button" class=
        "delete-button-modal">Delete Player</button>
      </div>
    </div>
  </div>
  <div id="add-player-modal" class="modal-overlay hidden" onclick=
  "closeModal(event, 'add-player-modal')">
    <div class="modal-content">
      <h3>Add Player</h3><input type="text" id="new-player-name"
      placeholder="Player Name">
      
      <label for="new-player-fav-position">Favorite Position (optional)</label>
      <select id="new-player-fav-position">
        <option value="">Auto (best avg +/-)</option>
        <option value="GS">GS - Goal Shooter</option>
        <option value="GA">GA - Goal Attack</option>
        <option value="WA">WA - Wing Attack</option>
        <option value="C">C - Centre</option>
        <option value="WD">WD - Wing Defence</option>
        <option value="GD">GD - Goal Defence</option>
        <option value="GK">GK - Goal Keeper</option>
      </select>
      
      <div class="modal-actions">
        <button class="cancel-btn" onclick=
        "hideModal('add-player-modal')">Cancel</button> <button id=
        "add-player-button">Add</button>
      </div>
    </div>
  </div>
  <div id="add-game-modal" class="modal-overlay hidden" onclick=
  "closeModal(event, 'add-game-modal')">
    <div class="modal-content">
      <h3 id="add-game-modal-title">Add Game</h3><label for=
      "new-game-round">Round</label> <input type="number" id=
      "new-game-round" placeholder="e.g., 1"> <label for=
      "new-game-date">Date</label> <input type="date" id=
      "new-game-date"> <label for="new-game-time">Game
      Time</label> <input type="time" id="new-game-time"
      placeholder="e.g., 14:30"> <label for=
      "new-game-court">Court</label> <input type="text" id=
      "new-game-court" placeholder="e.g., Court 1"> 
      <label for="new-game-venue">Venue üìç</label> 
      <div style="display: flex; gap: 8px;">
        <input type="text" id="new-game-venue" placeholder="e.g., Smith Park" style="flex: 1;">
        <button type="button" onclick="getCurrentLocation()" class="icon-button" title="Use current location">üìç</button>
      </div>
      <label for="new-game-status">Game
      Status</label> <select id="new-game-status" onchange=
      "toggleOpponentField(this.value)">
        <option value="normal">
          Normal
        </option>
        <option value="bye">
          BYE
        </option>
        <option value="forfeit_us">
          Forfeited by Us
        </option>
        <option value="forfeit_opp">
          Forfeited by Opponent
        </option>
        <option value="abandoned">
          Abandoned
        </option>
      </select> <label for="new-game-opponent">Opponent</label>
      <input type="text" id="new-game-opponent" placeholder=
      "Opponent Name">
      <div class="modal-actions">
        <button class="cancel-btn" onclick=
        "hideModal('add-game-modal')">Cancel</button> <button id=
        "add-game-button">Add</button>
      </div>
      <div id="delete-game-zone" class="modal-delete-zone hidden">
        <button id="delete-game-button" class=
        "delete-button-modal">Delete Game</button>
      </div>
    </div>
  </div>
  <div id="share-lineup-modal" class="modal-overlay hidden"
  onclick="closeModal(event, 'share-lineup-modal')">
    <div class="modal-content">
      <h3>Share Lineup</h3>
      <p style="text-align: center; color: var(--secondary-text);">
      Screenshot this card to share with your team.</p>
      <div id="share-lineup-validation-modal" style=
      "margin-bottom: 16px;"></div>
      <div id="share-lineup-card-modal"></div>
      <div class="modal-actions" style="margin-top: 20px;">
        <button class="cancel-btn" onclick=
        "hideModal('share-lineup-modal')">Close</button>
      </div>
    </div>
  </div>
  <div id="season-summary-view" class="view hidden">
    <div class="view-header">
      <button class="back-button" onclick="hideView('season-summary-view')" aria-label="Back to previous view">‚Üê</button>
      <h2>Season Summary</h2>
    </div>
    <div id="season-summary-slides" style="background: var(--primary-color); min-height: 400px; display: flex; align-items: center; justify-content: center;"></div>
    <div class="summary-nav">
      <button id="summary-prev" onclick="navigateSummary(-1)">‚Üê Back</button>
      <span id="slide-counter" style="color: white; font-weight: 600;">1 / 1</span>
      <button id="summary-next" onclick="navigateSummary(1)">Next ‚Üí</button>
    </div>
  </div>
  <div id="custom-alert-confirm-modal" class=
  "custom-modal-overlay hidden">
    <div class="custom-modal-content">
      <h3 id="custom-modal-title">Confirmation</h3>
      <p id="custom-modal-message">Are you sure?</p>
      <div class="custom-modal-actions" id="custom-modal-actions">
      </div>
    </div>
  </div><!-- server includes below -->
  <?!= include('js-startup'); ?>
  <?!= include('js-helpers'); ?>
  <?!= include('js-navigation'); ?>
  <?!= include('js-server-comms'); ?>
  <?!= include('js-core-logic'); ?>
  <?!= include('js-render'); ?>
  <?!= include('js-validation'); ?>
  <!-- Accessible live region for screen readers. Use `announce(msg)` to send messages. -->
  <div id="aria-live-region" role="status" aria-live="polite" aria-atomic="true" class="sr-only" aria-hidden="false"></div>
  <script>
    // Simple helper to announce messages to assistive technologies.
    // Usage: window.announce && window.announce('Your message');
    (function(){
      window.announce = function(msg){
        try{
          var el = document.getElementById('aria-live-region');
          if(!el) return;
          // Clear then set with a short delay to ensure assistive tech notices changes
          el.textContent = '';
          setTimeout(function(){ el.textContent = String(msg || ''); }, 60);
        }catch(e){ /* ignore */ }
      };
    })();
  </script>
  <script>
  // Move inline style for test insights button to CSS
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('show-insights-test-tab');
    var toggle = document.getElementById('toggle-test-insights');
    var toggle2 = document.getElementById('toggle-test-insights-2');
    var testView = document.getElementById('insights-test-view');
    
    // Toast helper for quick feedback
    function ensureToastContainer() {
        if (document.getElementById('toast-container')) return document.getElementById('toast-container');
        var c = document.createElement('div');
        c.id = 'toast-container';
        c.style = 'position:fixed;left:50%;transform:translateX(-50%);bottom:24px;z-index:99999;pointer-events:none;';
        document.body.appendChild(c);
        return c;
    }
    function showToast(msg, ms) {
        try {
            var cont = ensureToastContainer();
            var t = document.createElement('div');
            t.className = 'app-toast';
            t.style = 'background:rgba(0,0,0,0.78);color:#fff;padding:8px 12px;border-radius:8px;margin-top:8px;font-size:13px;pointer-events:auto;box-shadow:0 6px 18px rgba(0,0,0,0.25);';
            t.textContent = msg;
            cont.appendChild(t);
        try { if (window.announce && typeof window.announce === 'function') window.announce(msg); } catch (e) { /* ignore announce errors */ }
            setTimeout(function(){ t.style.opacity = '0'; setTimeout(function(){ t.remove(); }, 300); }, ms || 2000);
        } catch (e) { console.warn('showToast error', e); }
    }
    if (btn) {
        btn.addEventListener('click', function() {
            showView('insights-test-view');
        });
    }
    if (toggle && btn) {
        // Restore persisted preference (localStorage) or fall back to server feature flag
        var stored = null;
        try { stored = localStorage.getItem('testInsightsEnabled'); } catch (e) { stored = null; }
        var initialChecked = (stored !== null) ? (stored === 'true') : (window.TEST_INSIGHTS_ENABLED === true || window.TEST_INSIGHTS_ENABLED === 'true');
        toggle.checked = !!initialChecked;
        if (toggle2) toggle2.checked = !!initialChecked;
        btn.style.display = initialChecked ? '' : 'none';
        if (testView) {
            if (initialChecked) testView.classList.remove('hidden');
            else testView.classList.add('hidden');
        }

        var syncToggles = function(checked, source) {
            if (toggle && source !== 'a') toggle.checked = checked;
            if (toggle2 && source !== 'b') toggle2.checked = checked;
            if (btn) btn.style.display = checked ? '' : 'none';
        };

        toggle.addEventListener('change', function() {
            syncToggles(toggle.checked, 'a');
            try { localStorage.setItem('testInsightsEnabled', toggle.checked ? 'true' : 'false'); } catch (e) {}
                try {
                    if (window.google && google.script && google.script.run) {
                        google.script.run.recordTelemetry('client.testInsightsToggle', { user: window._USER_EMAIL || '', enabled: !!toggle.checked, source: 'toggle-a' });
                    }
                } catch (e) { /* ignore telemetry errors */ }
            if (toggle.checked) {
                // Immediately show the test insights view
                showView('insights-test-view');
                showToast('Test Insights enabled');
            } else {
                // Immediately return to the standard insights view
                showView('insights-view');
                showToast('Test Insights disabled');
            }
        });

        if (toggle2) {
            toggle2.addEventListener('change', function() {
                syncToggles(toggle2.checked, 'b');
                try { localStorage.setItem('testInsightsEnabled', toggle2.checked ? 'true' : 'false'); } catch (e) {}
                try {
                    if (window.google && google.script && google.script.run) {
                        google.script.run.recordTelemetry('client.testInsightsToggle', { user: window._USER_EMAIL || '', enabled: !!toggle2.checked, source: 'toggle-b' });
                    }
                } catch (e) { /* ignore telemetry errors */ }
                if (toggle2.checked) {
                    showView('insights-test-view');
                    showToast('Test Insights enabled');
                } else {
                    showView('insights-view');
                    showToast('Test Insights disabled');
                }
            });
        }
    }
    // Fallback for Apps Script variables for local dev
    if (typeof window.google === 'undefined') {
        window.google = {};
    }
    // Floating debug toggle button (toggles window.DEBUG_TEST_INSIGHTS)
    try {
        // Debug toggle removed - not needed in production
        window.DEBUG_TEST_INSIGHTS = false;
    } catch (e) { /* ignore */ }
    // Fallback for _USER_EMAIL for local dev
    if (typeof window._USER_EMAIL === 'undefined') {
        window._USER_EMAIL = 'localdev@example.com';
    }
    // Patch showView to avoid errors if view is missing
    if (typeof window.showView === 'function') {
        var origShowView = window.showView;
        window.showView = function(viewId) {
            var el = document.getElementById(viewId);
            if (!el) {
                console.warn('View not found:', viewId);
                return;
            }
            // Hide test insights button if switching away from insights-view
            var toggle = document.getElementById('toggle-test-insights');
            var btn = document.getElementById('show-insights-test-tab');
                if (toggle && btn) {
                if (viewId !== 'insights-view') {
                    btn.style.display = 'none';
                    toggle.checked = false;
                        var toggle2 = document.getElementById('toggle-test-insights-2');
                        if (toggle2) toggle2.checked = false;
                }
            }
            return origShowView.apply(this, arguments);
        };
    }

    // Make insight dashboard cards clickable and keyboard-accessible
    try {
      function makeClickableCard(el, viewId) {
        if (!el) return;
        el.style.cursor = 'pointer';
        el.setAttribute('tabindex', '0');
        el.setAttribute('role', 'button');
        el.addEventListener('click', function (ev) {
          // avoid intercepting clicks on nested interactive controls
          if (ev.target && (ev.target.closest('a') || ev.target.closest('button') || ev.target.closest('input'))) return;
          if (typeof showView === 'function') showView(viewId);
        });
        el.addEventListener('keydown', function (ev) {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); if (typeof showView === 'function') showView(viewId); }
        });
      }

      // Team summary cards -> team record view
      document.querySelectorAll('.match-summary-grid .team-stats').forEach(function (n) { makeClickableCard(n, 'insights-team-record-view'); });

      // Quarter flow canvas -> team record view
      makeClickableCard(document.getElementById('quarter-flow-viz'), 'insights-team-record-view');

      // Offensive summary values -> offense hub
      ['efficient-scorer-avg', 'total-combinations', 'insights-our-avg', 'insights-their-avg'].forEach(function (id) {
        makeClickableCard(document.getElementById(id), 'insights-offense-hub-view');
      });

      // Player spotlights: route defenders to defensive view, otherwise offense hub
      document.querySelectorAll('.player-spotlight').forEach(function (n) {
        var isDef = n.querySelector('[id^="top-defender"]') || n.querySelector('[id^="top-dpair"]');
        makeClickableCard(n, isDef ? 'insights-defense-view' : 'insights-offense-hub-view');
      });

      // Impact stats -> player +/- view
      ['impact-gs', 'impact-ga', 'impact-c', 'impact-gk'].forEach(function (id) { makeClickableCard(document.getElementById(id), 'insights-player-plusminus-view'); });

      // Defensive stats -> defense view
      ['avg-ga', 'defensive-quarters', 'insights-best-qtr', 'insights-avg-margin'].forEach(function (id) { makeClickableCard(document.getElementById(id), 'insights-defense-view'); });

      // Ensure test snapshot cards already clickable keep behaviour (no-op if missing)
      document.querySelectorAll('.test-snapshot-card').forEach(function (n) { if (!n.onclick) n.addEventListener('click', function () { showView('insights-test-view'); }); });

      // Wire the new 2x2 offensive leader cards to open detailed leaderboards
      function wireOffenseCard(cardId, sortMode, focusId) {
        var el = document.getElementById(cardId);
        if (!el) return;
        el.setAttribute('tabindex', '0');
        el.setAttribute('role', 'button');
        el.style.cursor = 'pointer';
        var openDetail = function() {
          try {
            // choose the hub tab based on where the card should focus
            var hubTab = (focusId === 'insights-offense-combos') ? 'pairs' : 'singles';
            try {
                if (!window.appState) window.appState = {};
                if (!window.appState.insights) window.appState.insights = {};
                window.appState.insights.offenseHubTab = hubTab;
            } catch (e) { /* ignore */ }

            if (typeof setOffenseHubTab === 'function') setOffenseHubTab(hubTab);
            if (typeof showInsightsSubView === 'function') showInsightsSubView('insights-offense-hub-view');

            if (typeof setInsightsSort === 'function') {
              if (hubTab === 'singles') setInsightsSort('single', sortMode);
              else setInsightsSort('offense', sortMode);
            } else if (window.appState && window.appState.insights) {
              if (hubTab === 'singles') window.appState.insights.sortSingle = sortMode;
              else window.appState.insights.sortOffense = sortMode;
              if (typeof renderOffensiveHub === 'function') renderOffensiveHub();
            }

            // scroll to the relevant section after render
            setTimeout(function(){ try { var f = document.getElementById(focusId); if (f && f.scrollIntoView) f.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e){} }, 150);
          } catch (e) { console.warn('openOffenseDetail error', e); }
        };
        el.addEventListener('click', openDetail);
        el.addEventListener('keydown', function(ev){ if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); openDetail(); } });
      }

      wireOffenseCard('card-single-total','impact','leaderboard-list-total');
      wireOffenseCard('card-single-avg','avg','leaderboard-list-per-qtr');
      wireOffenseCard('card-pair-total','impact','insights-offense-combos');
      wireOffenseCard('card-pair-avg','avg','insights-offense-combos');

      // Attach keyboard navigation to the hub tabs and initialize tab state from localStorage
      try {
        var hubTabs = Array.prototype.slice.call(document.querySelectorAll('.hub-tabs [role="tab"]'));
        if (hubTabs && hubTabs.length) {
          hubTabs.forEach(function(btn, idx) {
            btn.addEventListener('keydown', function(e) {
              var key = e.key;
              if (key === 'ArrowRight' || key === 'Right') { e.preventDefault(); var next = hubTabs[(idx + 1) % hubTabs.length]; next.focus(); }
              else if (key === 'ArrowLeft' || key === 'Left') { e.preventDefault(); var prev = hubTabs[(idx - 1 + hubTabs.length) % hubTabs.length]; prev.focus(); }
              else if (key === 'Home') { e.preventDefault(); hubTabs[0].focus(); }
              else if (key === 'End') { e.preventDefault(); hubTabs[hubTabs.length - 1].focus(); }
              else if (key === 'Enter' || key === ' ') { e.preventDefault(); btn.click(); }
            });
          });
          // Initialize tab from localStorage if present
          try {
            var stored = null;
            try { stored = localStorage.getItem('offenseHubTab'); } catch(e) { stored = null; }
            if (stored && typeof setOffenseHubTab === 'function') setOffenseHubTab(stored);
          } catch (e) { /* ignore */ }
          // Wire the per-tab "Show Top 3 / Show All" toggle button
          try {
            var showAllBtn = document.getElementById('offense-show-all-toggle');
            function updateShowAllButtonText() {
              try {
                var currentTab = (window.appState && window.appState.insights && window.appState.insights.offenseHubTab) || (localStorage.getItem('offenseHubTab') || 'singles');
                if (!showAllBtn) return;
                if (currentTab === 'singles') {
                  var val = !!(window.appState && window.appState.insights && window.appState.insights.showAllSingles);
                  showAllBtn.textContent = val ? 'Show Top 3' : 'Show All';
                  showAllBtn.setAttribute('aria-pressed', val ? 'true' : 'false');
                } else if (currentTab === 'pairs') {
                  // pairs uses its own inline toggle; hide hub-level toggle
                  showAllBtn.style.display = 'none';
                  return;
                } else {
                  // pairs uses its own toggle inside list; hide hub-level toggle
                  showAllBtn.style.display = 'none';
                  return;
                }
                showAllBtn.style.display = '';
              } catch (e) {}
            }

            if (showAllBtn) {
              showAllBtn.addEventListener('click', function() {
                var currentTab = (window.appState && window.appState.insights && window.appState.insights.offenseHubTab) || (localStorage.getItem('offenseHubTab') || 'singles');
                if (currentTab === 'singles' && typeof toggleSinglesShowAll === 'function') toggleSinglesShowAll();
                else if (currentTab === 'pairs' && typeof toggleInsightsOffense === 'function') toggleInsightsOffense();
                setTimeout(updateShowAllButtonText, 40);
              });
              // ensure label reflects current stored value
              setTimeout(updateShowAllButtonText, 80);
            }
          } catch (e) { /* ignore */ }
        }
      } catch (e) { /* ignore */ }
    } catch (e) { console.warn('Failed to wire insight card click handlers', e); }
  });
  </script>
</script>
  <script>
    // Ensure the Team Performance icon has a fallback when data: URLs are blocked or the image fails to load.
    (function(){
      try {
        function ensureTeamPerfFallback() {
          var img = document.querySelector('img[alt="Team Performance"]');
          if (!img) return;
          // If handler already attached, skip
          if (img.__tp_fallback_attached) return;
          img.__tp_fallback_attached = true;
          // create an inline SVG fallback (hidden by default)
          var svg = img.nextElementSibling;
          if (!svg || !(svg instanceof SVGElement)) {
            svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
            svg.setAttribute('viewBox','0 0 64 64');
            svg.setAttribute('width','36');
            svg.setAttribute('height','36');
            svg.setAttribute('aria-hidden','true');
            svg.style.display = 'none';
            svg.style.borderRadius = '6px';
            svg.style.overflow = 'visible';
            svg.innerHTML = '<defs><linearGradient id="tp_g1" x1="0" x2="1"><stop offset="0" stop-color="#ffb347"/><stop offset="1" stop-color="#ffcc33"/></linearGradient></defs>'+
                            '<circle cx="32" cy="32" r="18" fill="url(#tp_g1)" stroke="#cc8a00" stroke-width="2"/>'+
                            '<path d="M32 14 L32 50 M14 32 L50 32 M20 20 L44 44 M44 20 L20 44" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>';
            img.parentNode.insertBefore(svg, img.nextSibling);
          }
          // onerror: hide the broken image and show svg
          img.addEventListener('error', function(){ try { img.style.display='none'; svg.style.display='block'; } catch(e){} });
          // if the image is already complete but naturalWidth==0, trigger fallback
          if (img.complete && img.naturalWidth === 0) {
            try { img.style.display='none'; if (svg) svg.style.display='block'; } catch(e){}
          }
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ensureTeamPerfFallback);
        else ensureTeamPerfFallback();
        // also run on subsequent DOM changes (in case the insights menu is rendered later)
        var obs = new MutationObserver(function(){ ensureTeamPerfFallback(); });
        obs.observe(document.body, { childList: true, subtree: true });
      } catch (e) { console.warn('TeamPerf fallback script error', e); }
    })();
  </script>
</body>
</html>
