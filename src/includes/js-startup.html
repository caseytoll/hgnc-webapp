<script>
    // === APP STARTUP ===
    document.addEventListener('DOMContentLoaded', function() {
        // Remove preload class to enable transitions
        setTimeout(() => {
            document.body.classList.remove('preload');
        }, 100);
        
        // Dark mode: Auto-detect system preference and listen for changes
        function updateDarkMode() {
            var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            var userPreference = localStorage.getItem('darkMode');
            
            // User preference overrides system setting
            var useDarkMode = userPreference !== null ? userPreference === 'true' : prefersDark;
            
            if (useDarkMode) {
                document.documentElement.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
            }
        }
        
        // Initialize dark mode
        updateDarkMode();
        
        // Listen for system dark mode changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
            if (localStorage.getItem('darkMode') === null) {
                updateDarkMode();
            }
        });
        
        // Expose dark mode toggle function
        window.toggleDarkMode = function() {
            var currentPreference = localStorage.getItem('darkMode');
            var newPreference = currentPreference === 'true' ? 'false' : 'true';
            localStorage.setItem('darkMode', newPreference);
            updateDarkMode();
        };
        
        // Initialize network status monitoring
        updateNetworkStatus();
        
        // Initialize allTeamData for dashboard rendering
        window.allTeamData = {};
        console.log('[STARTUP] Initialized allTeamData:', window.allTeamData);
        
        // Check for PWA install prompt after short delay
        setTimeout(function() {
            checkInstallPrompt();
        }, 3000);
        
        // Set logo on initial page load
        var mainLogo = document.getElementById('main-logo');
        if (mainLogo && window.LOGO_DATA_URL) {
            mainLogo.src = window.LOGO_DATA_URL;
        }
        
        // Wait a bit for DOM to be fully ready
        setTimeout(function() {
            // OPTIMIZATION: Cache DOM elements for performance
            cacheCommonElements();
            
            // Basic button assignments
            document.getElementById('add-player-button').onclick = addPlayer;
            document.getElementById('add-game-button').onclick = addOrUpdateGame;
            
            // --- *** Modified: Show all admin buttons if user is owner but extract into named function *** ---
            console.log('ðŸ”‘ App Version: v932 - Added explicit colors | User is owner:', isOwner());
            
            function applyOwnerModeUI() {
                try {
                    var readOnlyBanner = document.getElementById('read-only-banner');
                    if (isOwner()) {
                        // Hide read-only banner for owners
                        if (readOnlyBanner) {
                            readOnlyBanner.classList.add('hidden');
                        }

                        // Show "Create New Team" button
                        var addTeamButton = document.getElementById('show-add-team-modal');
                        if (addTeamButton) {
                            addTeamButton.classList.remove('hidden');
                            addTeamButton.onclick = showAddTeamModal;
                        }

                        // Show "Toggle Edit Mode" button (teams) so owners can edit
                        var toggleEditButton = document.getElementById('toggle-edit-mode');
                        if (toggleEditButton) {
                            toggleEditButton.classList.remove('hidden');
                            // Wire to toggle function if not already wired in HTML
                            toggleEditButton.onclick = toggleTeamEditMode;
                            // Ensure label reflects current mode state
                            toggleEditButton.textContent = isTeamEditMode ? 'Done' : 'Edit';
                        }

                        // Show "Add Player" button
                        var addPlayerButton = document.getElementById('show-add-player-modal');
                        if (addPlayerButton) {
                            addPlayerButton.classList.remove('hidden');
                            addPlayerButton.onclick = function() { showModal('add-player-modal'); };
                        }

                        // Show "Add Game" button
                        var addGameButton = document.getElementById('show-add-game-modal');
                        if (addGameButton) {
                            addGameButton.classList.remove('hidden');
                            addGameButton.onclick = showAddGameModal;
                        }

                        // Show game-detail edit tab button
                        var editGameNavButton = document.getElementById('show-edit-tab');
                        if (editGameNavButton) {
                            editGameNavButton.classList.remove('hidden');
                        }

                        // Show and set up Admin button in Insights view
                        var adminButton = document.getElementById('show-admin-view-btn');
                        if (adminButton) {
                            adminButton.classList.remove('hidden');
                            adminButton.onclick = function() {
                                showView('admin-view');
                            };
                        }

                        // Set up Admin save button
                        var saveTokenButton = document.getElementById('admin-save-token-btn');
                        if (saveTokenButton) {
                            // ensure it's wired to call server-side function
                            saveTokenButton.onclick = function() { saveTokenFromAdmin(); };
                        }
                    } else {
                        // Non-owner: ensure admin UI is hidden
                        if (readOnlyBanner) readOnlyBanner.classList.remove('hidden');
                        var selectors = ['show-add-team-modal', 'toggle-edit-mode', 'show-add-player-modal', 'show-add-game-modal', 'show-admin-view-btn', 'show-edit-tab'];
                        selectors.forEach(function(id){ var el = document.getElementById(id); if (el) el.classList.add('hidden'); });
                    }
                } catch (e) {
                    console.warn('applyOwnerModeUI error:', e);
                }
            }

            // Expose to global so the runtime-check harness can re-apply owner UI as needed
            try { window.applyOwnerModeUI = applyOwnerModeUI; } catch (e) { console.warn('Failed to export applyOwnerModeUI', e); }

            // Execute now to apply state
            try { applyOwnerModeUI(); } catch(e) { /* ignore errors here */ }
            // --- *** END MODIFICATION *** ---
            
            // Set up share modal button (only if element exists)
            var shareButton = document.getElementById('show-share-modal-btn');
            if (shareButton) {
                shareButton.onclick = showShareModal;
            }
            
            // Set up generate summary button (only if element exists)
            var summaryButton = document.getElementById('generate-summary-btn');
            if (summaryButton) {
                summaryButton.onclick = showSeasonSummary;
            } else {
                console.warn('generate-summary-btn element not found');
            }
            
            // Set up other buttons with safety checks
            var updatePlayerButton = document.getElementById('update-player-button');
            if (updatePlayerButton) {
                updatePlayerButton.onclick = updatePlayer;
            }
            
            var deletePlayerButton = document.getElementById('delete-player-button');
            if (deletePlayerButton) {
                deletePlayerButton.onclick = executeDeletePlayer;
            }
            
            var deleteTeamButton = document.getElementById('delete-team-button');
            if (deleteTeamButton) {
                deleteTeamButton.onclick = executeDeleteTeam;
            }
            
            var updateTeamButton = document.getElementById('update-team-button');
            if (updateTeamButton) {
                updateTeamButton.onclick = function() {
                    if(appState.editing.team) {
                        handleUpdateTeam();
                    } else {
                        handleCreateTeam();
                    }
                };
            }
            
            var deleteGameButton = document.getElementById('delete-game-button');
            if (deleteGameButton) {
                deleteGameButton.onclick = executeDeleteGame;
            }
            
            // Set up enter key for new player name
            var newPlayerNameInput = document.getElementById('new-player-name');
            if (newPlayerNameInput) {
                newPlayerNameInput.onkeyup = function(e) { 
                    var event = e || window.event;
                    if (event.key === 'Enter' || event.keyCode === 13) {
                        addPlayer(); 
                    }
                };
            }
            
            // Load the master team list
            loadMasterTeamList();
            
            // PHASE 3: Initialize advanced features
            initScrollAnimations();
            initTooltips();
            initLazyImages();
            
            // Initialize scroll progress indicator if present
            var scrollIndicator = document.querySelector('.scroll-indicator');
            if (scrollIndicator) {
                window.addEventListener('scroll', updateScrollIndicator);
                updateScrollIndicator();
            }
            
        }, 100); // Small delay to ensure DOM is ready
    });

    // Global error handler to surface view-level errors in a non-fatal way
    window.addEventListener('error', function(e) {
        try {
            console.error('Unhandled JS error:', e.message || e);
            var banner = document.getElementById('insights-player-analysis-error-banner');
            if (banner) {
                banner.textContent = 'An unexpected error occurred while rendering this view. Check console for details.';
                banner.classList.remove('hidden');
            }
        } catch (err) {
            // ignore errors in the handler
        }
    });

    // Ensure insights dashboard cards have valid images (fallback to local assets when necessary)
    // CDN tag is set to @master by default but can be changed with scripts/pin-cdn.sh
    const CDN_TAG = '@b00670a';
    const CDN_BASE = 'https://cdn.jsdelivr.net/gh/caseytoll/hgnc-webapp' + CDN_TAG + '/assets/';
    function ensureInsightsCardImages() {
        try {
            // Use globally-exposed icon data URLs (from server-data JSON) as primary fallback
            // Fall back to CDN URLs only if server injection completely failed
            const ICON_MAP = {
                'Team Performance': [window.TEAM_PERFORMANCE_ICON_DATA_URL || CDN_BASE + 'team-performance-icon-source.jpeg'],
                'Offensive Leaders': [window.OFFENSIVE_LEADERS_ICON_DATA_URL || CDN_BASE + 'Offensive-Leaders-Icon.jpeg'],
                'Defensive Wall': [window.DEFENSIVE_WALL_ICON_DATA_URL || CDN_BASE + 'Defensive-Wall-Icon.jpeg'],
                'Player Analysis': [window.PLAYER_ANALYSIS_ICON_DATA_URL || CDN_BASE + 'player-analysis-icon.webp', CDN_BASE + 'player-analysis-icon-small.png']
            };

            const cards = document.querySelectorAll('.insights-menu-card');
            cards.forEach(card => {
                const title = card.querySelector('.insights-menu-card-title')?.textContent?.trim() || '';
                const computedBg = window.getComputedStyle(card).backgroundImage || '';
                
                // All cards now use standardized 'data-icon' attribute (set by server or fallback script)
                let injected = card.getAttribute('data-icon');
                
                // If the data-icon attribute contains '#' (failed server injection), use globally-exposed URL
                if (!injected || injected === '#' || injected.trim() === '') {
                    const globalUrl = ICON_MAP[title];
                    if (globalUrl && globalUrl.length > 0 && globalUrl[0] !== '#') {
                        injected = globalUrl.join(', ');
                        card.setAttribute('data-icon', injected);
                    }
                }
                
                if (injected && injected !== '#' && injected.length > 0) {
                    // injected may be a single url or comma-separated list of urls
                    const urlList = injected.split(',').map(u => u.trim());
                    const ensureDataUrl = function(u) {
                        if (!u) return null;
                        u = u.replace(/(^"|"$)/g, '');
                        // Already a full data: URL or absolute URL - validate data: payload exists
                        if (u.indexOf('data:') === 0) {
                            const commaIdx = u.indexOf(',');
                            if (commaIdx === -1) return null; // malformed
                            const payload = u.slice(commaIdx + 1).trim();
                            if (!payload) return null; // no payload
                            return u;
                        }
                        if (u.indexOf('http') === 0 || u.startsWith('/')) return u;
                        // Heuristics for common base64 starting sequences
                        if (/^\/9j\//.test(u)) return 'data:image/jpeg;base64,' + u;
                        if (/^PHN2Zy/i.test(u)) return 'data:image/svg+xml;base64,' + u;
                        // Generic base64 fallback: assume SVG if it starts with a base64-like string
                        if (/^[A-Za-z0-9\+/=\s]+$/.test(u)) return 'data:image/svg+xml;base64,' + u;
                        return u;
                    };
                    const sanitized = urlList.map(u => ensureDataUrl(u)).filter(Boolean);
                    if (!sanitized || sanitized.length === 0) return;
                    const bgVal = sanitized.map(u => `url('${u}')`).join(', ');
                    card.style.setProperty('background-image', bgVal, 'important');
                    return;
                }
                
                // If the computed background points to Apps Script assets or is empty, replace it
                if (!computedBg || computedBg === 'none' || computedBg.includes('script.googleusercontent.com') || (computedBg.includes('data:image') && computedBg.length < 80)) {
                    const fallback = [CDN_BASE + 'player-analysis-icon.webp', CDN_BASE + 'player-analysis-icon-small.png'];
                    const urlList = (ICON_MAP[title] && Array.isArray(ICON_MAP[title]) ? ICON_MAP[title] : fallback);
                    // Build CSS multi-background: url(a), url(b)
                    const bg = urlList.map(u => `url('${u}')`).join(', ');
                    card.style.setProperty('background-image', bg, 'important');
                }
            });
        } catch (e) {
            console.warn('ensureInsightsCardImages: error', e);
        }
    }

    // Run a few times to ensure late-rendered elements are handled
    document.addEventListener('DOMContentLoaded', function() {
        ensureInsightsCardImages();
        // Retry a couple times in case the cards render later
        setTimeout(ensureInsightsCardImages, 1000);
        setTimeout(ensureInsightsCardImages, 2500);
    });
</script>